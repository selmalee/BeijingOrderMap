var geoq={map:null,data:null,statis:null,highlight:null,pop:null,markers:{},field:{time:"案发时间",type:"案件类型",area:"区域分布",count:"点名次数",lng:"经度",lat:"纬度"},radius:{min:5,max:36},query:{type:"",time:""},interval:450,frames:20,max:45,minWidth:219,fillColor:"#cc9933",load:function(){this._loading(),this._map(),this._data()},start:function(){this._draw(this.data,this.statis)},setType:function(t){var e=this.query;e.type=t,this._change(this.data,e)},setTime:function(t){var e=this.query;e.time=t,this._change(this.data,e)},_map:function(){var t=new L.map("map",{minZoom:3,maxZoom:16,zoomControl:!1,attributionControl:!1}).setView([39.90802,116.37714],11);t.on("click",this._nohighlight,this),L.control.attribution().addAttribution('<a href="http://www.geoq.cn" target="_blank">智图GeoQ</a>').addTo(t),L.tileLayer.esri("http://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetGray/MapServer").addTo(t),this.map=t},_data:function(){var t=this;this.util.get("data/security.csv","text",function(e){var i=t._parse(e);t.data=i;var n=t._statis(i.rows);t.statis=n,t._times(),t._loadend()},function(e){t._loadend(),alert("数据加载失败")})},_times:function(){for(var t,e,i=document.querySelector(".year .time-list"),n=document.querySelector(".month .time-list"),o=4;6>o;o++){t=L.DomUtil.create("div","row",i),t.innerHTML=o;for(var r=1;13>r;r++)e=L.DomUtil.create("div","row",n),e.innerHTML=r}i.style.height="54px",n.style.height="648px"},_draw:function(t,e){var i=0,n=t.times.length,o=null,r=this,a=function(){if(n>i){if(r._tip(t,i),r._bigger(t,e,i),++i,9===i){var l=window.parent;l&&"function"==typeof l.showIntro&&l.showIntro.call(null)}o=setTimeout(a,r.interval)}else{clearTimeout(o);var s=document.querySelector("#tip");s.parentNode.removeChild(s),r._popup(),r._highlight("西城区西单大街",n-1)}};o=setTimeout(a,this.interval)},_tip:function(t,e){var i=document.querySelector("#tip");i.style.display="block";var n=document.querySelector(".year .time-list");n.style.top=12*-Math.floor(e/12)+"px";var o=document.querySelector(".month .time-list");o.style.top=12*-e+"px"},_bigger:function(t,e,i){var n=this._stamp(t,i);if(!(n.length<1)){for(var o,r,a,l=this.markers,s=this.field,h=t.times[i],u=0,c=n.length;c>u;u++)o=n[u],r=o[s.area],l[r]||(a=this._circle(r),a._from=0,l[r]=a),l[r]._to=this._radius(this._total(e,r,h));this._animate(l)}},_highlight:function(t,e){var i=this.markers[t];if(i){var n=L.DomUtil.create("div","popup"),o=this._count(this.data,t,e),r=[];r.push({icon:"area",title:"被点名地：",value:t}),r.push({icon:"count",title:"被点名数：",value:o});for(var a=0,l=r.length;l>a;a++)this._line(n,r[a]);this.pop?this.pop.setContent(n):(i.bringToFront(),i.setStyle({fillColor:this.fillColor}),this.pop=L.popup({closeButton:!1,minWidth:this.minWidth}).setLatLng(i.getLatLng()).setContent(n),this.pop.openOn(this.map),this.highlight=i)}},_count:function(t,e,i){for(var n,o=this.field,r=t.rows,a=+t.times[i],l=0,s=0,h=r.length;h>s;s++)n=r[s],n[o.area]!==e||+n[o.time]>a||(l+=+n[o.count]);return l},_change:function(t,e){var i,n,o,r,a=this._filter(t,e),l=this._statis(a),s=this.markers,h=Object.keys(s),u=Object.keys(l),c=this._compare(h,u);for(o=0,r=c.add.length;r>o;o++)n=c.add[o],i=this._circle(n),i._from=0,s[n]._to=this._radius(l[n].total),s[n]=i;for(o=0,r=c.del.length;r>o;o++)n=c.del[o],i=s[n],i._to=0;for(o=0,r=c.exist.length;r>o;o++)n=c.exist[o],i=s[n],s[n]._to=this._radius(l[n].total);this.statis=l,this.map.closePopup(),this._nohighlight(),this._animate(s)},_animate:function(t){var e,i,n,o=L.Util.requestAnimFrame,r=this.frames,a=null,l=0,s=function(){if(++l,r>=l){for(i in t)e=t[i],n=(e._to-e._from)/r,e.setRadius(e._from+n*l);a=o(s)}else{for(i in t)e=t[i],e._from=e._to;L.Util.cancelAnimFrame(a)}};a=o(s)},_compare:function(t,e){for(var i={add:[],exist:[],del:[]},n=0,o=e.length;o>n;n++)t.indexOf(e[n])<0?i.add.push(e[n]):i.exist.push(e[n]);for(var r=0,a=t.length;a>r;r++)e.indexOf(t[r])<0&&i.del.push(t[r]);return i},_popup:function(){var t,e=this.markers,i=this;for(var n in e)t=e[n],t.on("click",function(t){var e=t.target,n=e._name,o=i.data.geo;i._nohighlight(),i.highlight=e,e.setStyle({fillColor:i.fillColor}),i.map.openPopup(L.popup({closeButton:!1,minWidth:i.minWidth}).setLatLng(L.latLng(o[n])).setContent(i._content(n)))})},_content:function(t){var e=L.DomUtil.create("div","popup"),i=this.statis,n=(this.field,this.query),o=[];o.push({icon:"area",title:"被点名地：",value:t}),n.type?(n.time?4===n.time.length?o.push({icon:"count",title:"被点名数：",value:i[t].total}):6===n.time.length&&o.push({icon:"count",title:"被点名数：",value:i[t][n.time]}):o.push({icon:"count",title:"被点名数：",value:i[t].total}),o.unshift({icon:"type",title:"案件类型：",value:n.type})):n.time?4===n.time.length?o.push({icon:"count",title:"被点名数：",value:i[t].total}):6===n.time.length&&o.push({icon:"count",title:"被点名数：",value:i[t][n.time]}):o.push({icon:"count",title:"被点名数：",value:i[t].total});for(var r=0,a=o.length;a>r;r++)this._line(e,o[r]);return e},_line:function(t,e){var i=L.DomUtil.create("div","line",t),n=(L.DomUtil.create("i",e.icon,i),L.DomUtil.create("label","title bold",i)),o=L.DomUtil.create("label","value",i);n.innerHTML=e.title,o.innerHTML=e.value},_format:function(t,e){if("year"===e)return t+"年";var i=t.slice(0,4),n=+t.slice(-2);return i+"年"+n+"月"},_circle:function(t){var e=L.circleMarker(L.latLng(this.data.geo[t]),{color:"#848484",opacity:0,weight:0,fillColor:"#848484",fillOpacity:.8});return e._name=t,e.setRadius(0).addTo(this.map)},_nohighlight:function(){this.highlight&&this.highlight.setStyle({fillColor:"#848484"}),this.highlight=null},_radius:function(t){if(0===t)return 0;var e=this.radius;return e.min+Math.round((e.max-e.min)*t/this.max)},_parse:function(t){var e,i,n,o=t.split("\n"),r=o.shift().split(","),a=this.field,l=[],s={},h=[],u={},c=[],m={};for(e=0;e<r.length;e++)r[e]=r[e].trim().replace("\r","");for(e=0,n=o.length;n>e;e++){var p=o[e].split(","),f={};for(i=0;i<r.length;i++){var d=p[i];d?d.indexOf("\r")>-1&&(d=d.replace("\r","")):d="",f[r[i]]=d.trim()}s[f[a.area]]||(s[f[a.area]]=[f[a.lat],f[a.lng]]),u[f[a.time]]||(u[f[a.time]]=1,h.push(f[a.time])),m[f[a.type]]||(m[f[a.type]]=1,c.push(f[a.type])),l.push(f)}return h=h.sort(function(t,e){return t-e}),{rows:l,geo:s,times:h,types:c}},_filter:function(t,e){for(var i,n,o,r=this.field,a=t.rows,l=[],s=0,h=a.length;h>s;s++)i=a[s],n=i[r.type],o=i[r.time],e.type&&n!==e.type||e.time&&o.slice(0,e.time.length)!==e.time||l.push(i);return l},_stamp:function(t,e){for(var i,n=t.times[e],o=t.rows,r=this.field,a=[],l=0,s=o.length;s>l;l++)i=o[l],i[r.time]===n&&a.push(i);return a},_statis:function(t){for(var e,i,n,o,r,a,l=this.data.times,s=this.field,h={},u=0,c=t.length;c>u;u++)e=t[u],i=e[s.area],n=e[s.time],h[i]||(h[i]={}),h[i][n]?h[i][n]+=+e[s.count]:h[i][n]=+e[s.count];for(i in h){for(o=0,r=0,a=l.length;a>r;r++)h[i][l[r]]||(h[i][l[r]]=0),o+=h[i][l[r]];o>this.max&&(this.max=o),h[i].total=o}return h},_total:function(t,e,i){var n=t[e],o=0;for(var r in n)i>=r&&(o+=n[r]);return o},_loading:function(){var t=L.DomUtil.get("shelter");t.style.display="block"},_loadend:function(){var t=L.DomUtil.get("shelter");t.parentNode.removeChild(t)},iframe:function(){var t=document.createElement("iframe");t.setAttribute("width",0),t.setAttribute("height",0),t.setAttribute("src","http://www.geoq.cn/baidumedia.html?appid=security"),t.style.display="none",document.body.appendChild(t)}};geoq.util={get:function(t,e,i,n){var o=new XMLHttpRequest,r=this;return o.open("GET",t,!0),o.send(null),o.onload=function(t){if("function"==typeof i){var n=t.target.responseText;"json"===e&&(n=JSON.parse(n)),i.call(r,n)}},o.onerror=function(t){"function"==typeof n&&n.call(r,t)},o}},L.DomEvent.on(document,"DOMContentLoaded",function(){geoq.load(),geoq.iframe()});