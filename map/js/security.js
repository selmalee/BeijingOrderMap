var geoq={map:null,basemap:"http://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer",field:{city:"城市",county:"区县",street:"街道",address:"地址",count:"被点名次数",lng:"经度",lat:"纬度"},radius:{min:5,max:30},load:function(){this._loading(),this._map(),this._data()},_map:function(){this.map=new L.map("map",{minZoom:3,maxZoom:16,zoomControl:!0,attributionControl:!1}).setView([39.9221,116.4441],11),L.control.attribution().addAttribution('<a href="http://www.geoq.cn" target="_blank">智图GeoQ</a>').addTo(this.map),L.tileLayer.esri(this.basemap).addTo(this.map)},_data:function(){var t=this;this.util.get("data/data.txt","text",function(e){var i=t._parse(e);t._markers(i),t._legend(),t._loadend()},function(t){alert("数据加载失败")})},_markers:function(t){for(var e=t.rows,i=0,n=e.length;n>i;i++)this._circle(e[i])},_circle:function(t){var e=this.field,i=t[e.lng],n=t[e.lat],r=t[e.count],o=L.latLng(n,i),a=this._radius(r),l={fields:[{title:!0,name:e.county},{title:!0,name:e.street},{title:!0,name:e.count}]},s=L.circleMarker(o,{color:"#fff",opacity:1,weight:0,fillColor:"#00a6ec",fillOpacity:.6}).setRadius(a).addTo(this.map);s._row=t,this.popup.bind(s,l)},_legend:function(){var t,e,i,n,r,o,a=this.util.query(".legend"),l=[1,6,12,18,24,30,36],s=L.DomUtil.create("label","title normal",a);s.innerHTML=this.field.count;for(var c=0,u=l.length;u>c;c++)t=l[c],e=this._radius(t),i=L.DomUtil.create("div","row center",a),n=L.DomUtil.create("div","circle",i),r=L.DomUtil.create("a","",n),r.style.width=2*e+"px",r.style.height=2*e+"px",r.style.borderRadius=e+"px",o=L.DomUtil.create("label","small",i),o.innerHTML=t},_radius:function(t){var e=this.radius;return e.min+Math.round((e.max-e.min)*t/36)},_labelIcon:function(t){var e='<label class="fontfix hover" style="color:{color}; font-size:{size}px">{text}</label>',i=this._linepx(t+"",12),n=Math.round(i.w/2),r=Math.round(i.h/2);return L.divIcon({iconSize:[i.w,i.h],iconAnchor:[n,r],className:"leaflet-div-icon-points",html:L.Util.template(e,{color:"rgba(255, 255, 255, 1)",size:12,text:t})})},_linepx:function(t,e){if(!t)return{w:0,h:0};var i=t.replace(/[^\x00-\xff]/g,"**").length,n=Math.floor(e/2)+1,r=e+e%10+1;return 7>n&&(n=7),14>r&&(r=14),{w:i*n,h:r}},_parse:function(t){var e,i,n,r=t.split("\n"),o=r.shift().split(","),a=[];for(e=0;e<o.length;e++)o[e]=o[e].trim().replace("\r","");for(e=0,n=r.length;n>e;e++){var l=r[e].split(","),s={};for(i=0;i<o.length;i++){var c=l[i];c?c.indexOf("\r")>-1&&(c=c.replace("\r","")):c="",s[o[i]]=c.trim()}a.push(s)}return{fields:o,rows:a}},_loading:function(){var t=L.DomUtil.get("shelter");t.style.display="block"},_loadend:function(){var t=L.DomUtil.get("shelter");t.parentNode.removeChild(t)},iframe:function(){var t=document.createElement("iframe");t.setAttribute("width",0),t.setAttribute("height",0),t.setAttribute("src","http://www.geoq.cn/baidumedia.html?appid=security"),t.style.display="none",document.body.appendChild(t)}};geoq.popup={bind:function(t,e){var i={closeButton:!1,minWidth:200},n=L.DomUtil.create("div","popup");this._create(n,t._row,e);var r=L.popup(i).setContent(n);t.bindPopup(r)},_create:function(t,e,i){for(var n,r=i.fields,o=null,a=0,l=r.length;l>a;a++)n=r[a],o=e[n.name],n.title&&(o=n.name+"："+o),this._line(t,o,!1)},_line:function(t,e,i){var n="line";i&&(n+=" title");var r=L.DomUtil.create("label",n,t);e&&(r.innerHTML=e)}},geoq.util={get:function(t,e,i,n){var r=new XMLHttpRequest,o=this;return r.open("GET",t,!0),r.send(null),r.onload=function(t){if("function"==typeof i){var n=t.target.responseText;"json"===e&&(n=JSON.parse(n)),i.call(o,n)}},r.onerror=function(t){"function"==typeof n&&n.call(o,t)},r},query:function(t){return document.querySelector(t)}},L.DomEvent.on(document,"DOMContentLoaded",function(){geoq.load(),geoq.iframe()});